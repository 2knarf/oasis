From 4c52200f4480b8f0491d79df9934918762376d81 Mon Sep 17 00:00:00 2001
From: Michael Forney <mforney@mforney.org>
Date: Tue, 26 Nov 2019 18:52:13 -0800
Subject: [PATCH] io: avoid use of packed struct

---
 src/io.c | 143 ++++++++++++++++++++++++++-----------------------------
 1 file changed, 67 insertions(+), 76 deletions(-)

diff --git a/src/io.c b/src/io.c
index af2f49a..9e6af3d 100644
--- a/src/io.c
+++ b/src/io.c
@@ -9,25 +9,19 @@
 #include <string.h>
 
 #include "fido.h"
-#include "packed.h"
-
-PACKED_TYPE(frame_t,
-struct frame {
-	uint32_t cid; /* channel id */
-	union {
-		uint8_t type;
-		struct {
-			uint8_t cmd;
-			uint8_t bcnth;
-			uint8_t bcntl;
-			uint8_t data[CTAP_RPT_SIZE - 7];
-		} init;
-		struct {
-			uint8_t seq;
-			uint8_t data[CTAP_RPT_SIZE - 5];
-		} cont;
-	} body;
-})
+
+/* CTAP section 8.1.4 */
+enum {
+	CID,
+
+	INIT_CMD = 4,
+	INIT_BCNTH,
+	INIT_BCNTL,
+	INIT_DATA,
+
+	CONT_SEQ = 4,
+	CONT_DATA,
+};
 
 #ifndef MIN
 #define MIN(x, y) ((x) > (y) ? (y) : (x))
@@ -36,14 +30,11 @@ struct frame {
 static int
 tx_empty(fido_dev_t *d, uint8_t cmd)
 {
-	struct frame	*fp;
-	unsigned char	 pkt[sizeof(*fp) + 1];
-	int		 n;
+	uint8_t	pkt[1 + CTAP_RPT_SIZE] = {0};
+	int	n;
 
-	memset(&pkt, 0, sizeof(pkt));
-	fp = (struct frame *)(pkt + 1);
-	fp->cid = d->cid;
-	fp->body.init.cmd = CTAP_FRAME_INIT | cmd;
+	memcpy(pkt + 1 + CID, &d->cid, 4);
+	pkt[1 + INIT_CMD] = CTAP_FRAME_INIT | cmd;
 
 	n = d->io.write(d->io_handle, pkt, sizeof(pkt));
 	if (n < 0 || (size_t)n != sizeof(pkt))
@@ -55,18 +46,15 @@ tx_empty(fido_dev_t *d, uint8_t cmd)
 static size_t
 tx_preamble(fido_dev_t *d, uint8_t cmd, const void *buf, size_t count)
 {
-	struct frame	*fp;
-	unsigned char	 pkt[sizeof(*fp) + 1];
-	int		 n;
-
-	memset(&pkt, 0, sizeof(pkt));
-	fp = (struct frame *)(pkt + 1);
-	fp->cid = d->cid;
-	fp->body.init.cmd = CTAP_FRAME_INIT | cmd;
-	fp->body.init.bcnth = (count >> 8) & 0xff;
-	fp->body.init.bcntl = count & 0xff;
-	count = MIN(count, sizeof(fp->body.init.data));
-	memcpy(&fp->body.init.data, buf, count);
+	uint8_t	pkt[1 + CTAP_RPT_SIZE] = {0};
+	int	n;
+
+	memcpy(pkt + 1 + CID, &d->cid, 4);
+	pkt[1 + INIT_CMD] = CTAP_FRAME_INIT | cmd;
+	pkt[1 + INIT_BCNTH] = (count >> 8) & 0xff;
+	pkt[1 + INIT_BCNTL] = count & 0xff;
+	count = MIN(count, CTAP_RPT_SIZE - INIT_DATA);
+	memcpy(pkt + 1 + INIT_DATA, buf, count);
 
 	n = d->io.write(d->io_handle, pkt, sizeof(pkt));
 	if (n < 0 || (size_t)n != sizeof(pkt))
@@ -78,16 +66,13 @@ tx_preamble(fido_dev_t *d, uint8_t cmd, const void *buf, size_t count)
 static size_t
 tx_frame(fido_dev_t *d, uint8_t seq, const void *buf, size_t count)
 {
-	struct frame	*fp;
-	unsigned char	 pkt[sizeof(*fp) + 1];
-	int		 n;
+	uint8_t	pkt[1 + CTAP_RPT_SIZE] = {0};
+	int	n;
 
-	memset(&pkt, 0, sizeof(pkt));
-	fp = (struct frame *)(pkt + 1);
-	fp->cid = d->cid;
-	fp->body.cont.seq = seq;
-	count = MIN(count, sizeof(fp->body.cont.data));
-	memcpy(&fp->body.cont.data, buf, count);
+	memcpy(pkt + 1 + CID, &d->cid, 4);
+	pkt[1 + CONT_SEQ] = seq;
+	count = MIN(count, CTAP_RPT_SIZE - CONT_DATA);
+	memcpy(pkt + 1 + CONT_DATA, buf, count);
 
 	n = d->io.write(d->io_handle, pkt, sizeof(pkt));
 	if (n < 0 || (size_t)n != sizeof(pkt))
@@ -142,39 +127,42 @@ fido_tx(fido_dev_t *d, uint8_t cmd, const void *buf, size_t count)
 }
 
 static int
-rx_frame(fido_dev_t *d, struct frame *fp, int ms)
+rx_frame(fido_dev_t *d, uint8_t *fp, int ms)
 {
 	int n;
 
-	n = d->io.read(d->io_handle, (unsigned char *)fp, sizeof(*fp), ms);
-	if (n < 0 || (size_t)n != sizeof(*fp))
+	n = d->io.read(d->io_handle, (unsigned char *)fp, CTAP_RPT_SIZE, ms);
+	if (n < 0 || (size_t)n != CTAP_RPT_SIZE)
 		return (-1);
 
 	return (0);
 }
 
 static int
-rx_preamble(fido_dev_t *d, uint8_t cmd, struct frame *fp, int ms)
+rx_preamble(fido_dev_t *d, uint8_t cmd, uint8_t *fp, int ms)
 {
+	uint32_t cid;
+
 	do {
 		if (rx_frame(d, fp, ms) < 0)
 			return (-1);
+		memcpy(&cid, &fp[CID], 4);
 #ifdef FIDO_FUZZ
-		fp->cid = d->cid;
+		cid = d->cid;
 #endif
-	} while (fp->cid == d->cid &&
-	    fp->body.init.cmd == (CTAP_FRAME_INIT | CTAP_KEEPALIVE));
+	} while (cid == d->cid &&
+	    fp[INIT_CMD] == (CTAP_FRAME_INIT | CTAP_KEEPALIVE));
 
 	fido_log_debug("%s: initiation frame at %p", __func__, (void *)fp);
-	fido_log_xxd(fp, sizeof(*fp));
+	fido_log_xxd(fp, CTAP_RPT_SIZE);
 
 #ifdef FIDO_FUZZ
-	fp->body.init.cmd = (CTAP_FRAME_INIT | cmd);
+	fp[INIT_CMD] = (CTAP_FRAME_INIT | cmd);
 #endif
 
-	if (fp->cid != d->cid || fp->body.init.cmd != (CTAP_FRAME_INIT | cmd)) {
+	if (cid != d->cid || fp[INIT_CMD] != (CTAP_FRAME_INIT | cmd)) {
 		fido_log_debug("%s: cid (0x%x, 0x%x), cmd (0x%02x, 0x%02x)",
-		    __func__, fp->cid, d->cid, fp->body.init.cmd, cmd);
+		    __func__, cid, d->cid, fp[INIT_CMD], cmd);
 		return (-1);
 	}
 
@@ -184,15 +172,16 @@ rx_preamble(fido_dev_t *d, uint8_t cmd, struct frame *fp, int ms)
 static int
 rx(fido_dev_t *d, uint8_t cmd, unsigned char *buf, size_t count, int ms)
 {
-	struct frame f;
-	uint16_t r, payload_len;
+	uint8_t		f[CTAP_RPT_SIZE];
+	uint32_t	cid;
+	uint16_t	r, payload_len;
 
-	if (rx_preamble(d, cmd, &f, ms) < 0) {
+	if (rx_preamble(d, cmd, f, ms) < 0) {
 		fido_log_debug("%s: rx_preamble", __func__);
 		return (-1);
 	}
 
-	payload_len = (f.body.init.bcnth << 8) | f.body.init.bcntl;
+	payload_len = (f[INIT_BCNTH] << 8) | f[INIT_BCNTL];
 	fido_log_debug("%s: payload_len=%zu", __func__, (size_t)payload_len);
 
 	if (count < (size_t)payload_len) {
@@ -200,16 +189,16 @@ rx(fido_dev_t *d, uint8_t cmd, unsigned char *buf, size_t count, int ms)
 		return (-1);
 	}
 
-	if (payload_len < sizeof(f.body.init.data)) {
-		memcpy(buf, f.body.init.data, payload_len);
+	if (payload_len < CTAP_RPT_SIZE - INIT_DATA) {
+		memcpy(buf, f + INIT_DATA, payload_len);
 		return (payload_len);
 	}
 
-	memcpy(buf, f.body.init.data, sizeof(f.body.init.data));
-	r = sizeof(f.body.init.data);
+	memcpy(buf, f + INIT_DATA, CTAP_RPT_SIZE - INIT_DATA);
+	r = CTAP_RPT_SIZE - INIT_DATA;
 
 	for (int seq = 0; (size_t)r < payload_len; seq++) {
-		if (rx_frame(d, &f, ms) < 0) {
+		if (rx_frame(d, f, ms) < 0) {
 			fido_log_debug("%s: rx_frame", __func__);
 			return (-1);
 		}
@@ -218,23 +207,25 @@ rx(fido_dev_t *d, uint8_t cmd, unsigned char *buf, size_t count, int ms)
 		    (void *)&f);
 		fido_log_xxd(&f, sizeof(f));
 
+		memcpy(&cid, f + CID, 4);
+
 #ifdef FIDO_FUZZ
-		f.cid = d->cid;
-		f.body.cont.seq = seq;
+		cid = d->cid;
+		f[CONT_SEQ] = seq;
 #endif
 
-		if (f.cid != d->cid || f.body.cont.seq != seq) {
+		if (cid != d->cid || f[CONT_SEQ] != seq) {
 			fido_log_debug("%s: cid (0x%x, 0x%x), seq (%d, %d)",
-			    __func__, f.cid, d->cid, f.body.cont.seq, seq);
+			    __func__, cid, d->cid, f[CONT_SEQ], seq);
 			return (-1);
 		}
 
-		if ((size_t)(payload_len - r) > sizeof(f.body.cont.data)) {
-			memcpy(buf + r, f.body.cont.data,
-			    sizeof(f.body.cont.data));
-			r += sizeof(f.body.cont.data);
+		if ((size_t)(payload_len - r) > CTAP_RPT_SIZE - CONT_DATA) {
+			memcpy(buf + r, f + CONT_DATA,
+			    CTAP_RPT_SIZE - CONT_DATA);
+			r += CTAP_RPT_SIZE - CONT_DATA;
 		} else {
-			memcpy(buf + r, f.body.cont.data, payload_len - r);
+			memcpy(buf + r, f + CONT_DATA, payload_len - r);
 			r += (payload_len - r); /* break */
 		}
 	}
-- 
2.26.1

