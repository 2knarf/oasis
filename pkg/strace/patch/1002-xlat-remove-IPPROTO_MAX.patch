From 9f4d1aa7bcac503ec834e1a608671ef1615db3e8 Mon Sep 17 00:00:00 2001
From: "Dmitry V. Levin" <ldv@altlinux.org>
Date: Sat, 28 Nov 2020 08:00:00 +0000
Subject: [PATCH] xlat: remove IPPROTO_MAX

* xlat/inet_protocols.in (IPPROTO_MAX): Remove.

Reported-by: Khem Raj <raj.khem@gmail.com>
Suggested-by: Eugene Syromiatnikov <esyr@redhat.com>
Resolves: https://github.com/strace/strace/issues/164
---
 xlat/inet_protocols.h  | 22 ++--------------------
 xlat/inet_protocols.in |  1 -
 2 files changed, 2 insertions(+), 21 deletions(-)

diff --git a/xlat/inet_protocols.h b/xlat/inet_protocols.h
index ea152ca..dd6cc8a 100644
--- a/xlat/inet_protocols.h
+++ b/xlat/inet_protocols.h
@@ -234,13 +234,6 @@ DIAG_POP_IGNORE_TAUTOLOGICAL_COMPARE
 #else
 # define IPPROTO_RAW 255
 #endif
-#if defined(IPPROTO_MAX) || (defined(HAVE_DECL_IPPROTO_MAX) && HAVE_DECL_IPPROTO_MAX)
-DIAG_PUSH_IGNORE_TAUTOLOGICAL_COMPARE
-static_assert((IPPROTO_MAX) == (256), "IPPROTO_MAX != 256");
-DIAG_POP_IGNORE_TAUTOLOGICAL_COMPARE
-#else
-# define IPPROTO_MAX 256
-#endif
 #if defined(IPPROTO_MPTCP) || (defined(HAVE_DECL_IPPROTO_MPTCP) && HAVE_DECL_IPPROTO_MPTCP)
 DIAG_PUSH_IGNORE_TAUTOLOGICAL_COMPARE
 static_assert((IPPROTO_MPTCP) == (262), "IPPROTO_MPTCP != 262");
@@ -353,12 +346,9 @@ static const struct xlat_data inet_protocols_xdata[] = {
  XLAT(IPPROTO_RAW),
  #define XLAT_VAL_32 ((unsigned) (IPPROTO_RAW))
  #define XLAT_STR_32 STRINGIFY(IPPROTO_RAW)
- XLAT(IPPROTO_MAX),
- #define XLAT_VAL_33 ((unsigned) (IPPROTO_MAX))
- #define XLAT_STR_33 STRINGIFY(IPPROTO_MAX)
  XLAT(IPPROTO_MPTCP),
- #define XLAT_VAL_34 ((unsigned) (IPPROTO_MPTCP))
- #define XLAT_STR_34 STRINGIFY(IPPROTO_MPTCP)
+ #define XLAT_VAL_33 ((unsigned) (IPPROTO_MPTCP))
+ #define XLAT_STR_33 STRINGIFY(IPPROTO_MPTCP)
 };
 const struct xlat inet_protocols[1] = { {
  .data = inet_protocols_xdata,
@@ -466,9 +456,6 @@ const struct xlat inet_protocols[1] = { {
 #  endif
 #  ifdef XLAT_VAL_33
   | XLAT_VAL_33
-#  endif
-#  ifdef XLAT_VAL_34
-  | XLAT_VAL_34
 #  endif
   ,
  .flags_strsz = 0
@@ -573,9 +560,6 @@ const struct xlat inet_protocols[1] = { {
 #  endif
 #  ifdef XLAT_STR_33
   + sizeof(XLAT_STR_33)
-#  endif
-#  ifdef XLAT_STR_34
-  + sizeof(XLAT_STR_34)
 #  endif
   ,
 } };
@@ -648,8 +632,6 @@ const struct xlat inet_protocols[1] = { {
 #  undef XLAT_VAL_32
 #  undef XLAT_STR_33
 #  undef XLAT_VAL_33
-#  undef XLAT_STR_34
-#  undef XLAT_VAL_34
 # endif /* !IN_MPERS */
 
 #endif /* !XLAT_MACROS_ONLY */
diff --git a/xlat/inet_protocols.in b/xlat/inet_protocols.in
index c37508f..89aa56a 100644
--- a/xlat/inet_protocols.in
+++ b/xlat/inet_protocols.in
@@ -32,5 +32,4 @@ IPPROTO_UDPLITE		136
 IPPROTO_MPLS		137
 IPPROTO_ETHERNET	143
 IPPROTO_RAW		255
-IPPROTO_MAX		256
 IPPROTO_MPTCP		262
-- 
2.29.2

